<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base de Datos Usuarios - PuraLlave</title>
    <style>
        :root {
            --primario: #0984e3; 
            --secundario: #00b894; 
            --fondo: #f1f7f9;
            --blanco: #ffffff;
            --texto: #2d3436;
            --borde: #dfe6e9;
            --seguridad: #e74c3c;
        }

        body.dark-mode {
            --fondo: #0f172a;
            --blanco: #1e293b;
            --texto: #f1f2f6;
            --primario: #3498db;
            --secundario: #55efc4;
            --borde: #334155;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; background: var(--fondo); color: var(--texto); transition: 0.3s; }
        
        /* HEADER */
        header { background: var(--blanco); padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        
        .logo-wrapper { display: flex; align-items: center; text-decoration: none; }
        .logo-icon { position: relative; width: 35px; height: 40px; margin-right: 10px; }
        .casa-tejado { width: 0; height: 0; border-left: 18px solid transparent; border-right: 18px solid transparent; border-bottom: 13px solid var(--secundario); }
        .casa-cuerpo { width: 28px; height: 22px; background: var(--secundario); margin: 0 auto; border-radius: 0 0 4px 4px; }
        .txt-pura { font-size: 1.6rem; font-weight: 800; color: var(--primario); }
        .txt-llave { font-size: 1.6rem; font-weight: 300; color: var(--secundario); }

        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        
        .seccion-titulo { border-bottom: 3px solid var(--secundario); display: inline-block; padding-bottom: 5px; margin-bottom: 25px; color: var(--primario); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        
        .alerta-seguridad { background: rgba(231, 76, 60, 0.1); border: 2px solid var(--seguridad); color: var(--seguridad); padding: 15px; border-radius: 10px; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .alerta-seguridad h3 { margin: 0; font-size: 1.1rem; }
        
        .estadisticas { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--blanco); padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stat-number { font-size: 2rem; font-weight: bold; color: var(--primario); margin-bottom: 5px; }
        .stat-label { color: var(--texto); opacity: 0.7; }
        
        .filtros { background: var(--blanco); padding: 20px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .filtros h3 { margin-top: 0; color: var(--primario); }
        .filtro-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .filtro-item label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--texto); opacity: 0.8; }
        .filtro-item select, .filtro-item input { width: 100%; padding: 8px; border: 1px solid var(--borde); border-radius: 8px; background: var(--fondo); color: var(--texto); }
        
        .tabla-container { background: var(--blanco); border-radius: 15px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .tabla { width: 100%; border-collapse: collapse; }
        .tabla th { background: var(--primario); color: white; padding: 12px; text-align: left; font-weight: 600; }
        .tabla td { padding: 12px; border-bottom: 1px solid var(--borde); }
        .tabla tr:hover { background: rgba(9, 132, 227, 0.05); }
        
        .estado-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; text-align: center; display: inline-block; }
        .estado-activo { background: rgba(0, 184, 148, 0.2); color: var(--secundario); }
        .estado-inactivo { background: rgba(149, 165, 166, 0.2); color: #95a5a6; }
        
        .seguridad-badge { background: rgba(231, 76, 60, 0.2); color: var(--seguridad); padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .encriptado { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        
        .acciones { display: flex; gap: 5px; }
        .btn-accion { padding: 4px 8px; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; transition: 0.2s; }
        .btn-ver { background: var(--primario); color: white; }
        .btn-editar { background: var(--secundario); color: white; }
        .btn-eliminar { background: #dc3545; color: white; }
        .btn-accion:hover { opacity: 0.8; transform: translateY(-1px); }
        
        .btn-dark-mode { position: fixed; bottom: 20px; right: 20px; z-index: 1000; padding: 12px 20px; border-radius: 50px; border: none; cursor: pointer; background: var(--primario); color: white; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: 0.3s; }
        .btn-exportar { background: var(--secundario); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 20px; }
        .btn-backup { background: var(--seguridad); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 20px; margin-left: 10px; }
        
        .datos-sensibles { font-family: 'Courier New', monospace; background: rgba(0,0,0,0.05); padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        
        @media (max-width: 768px) { 
            .header-content { flex-direction: column; gap: 15px; }
            .tabla-container { overflow-x: auto; }
            .filtro-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<button onclick="toggleDarkMode()" class="btn-dark-mode" id="btnDark">üåô Modo Oscuro</button>

<header>
    <div class="header-content">
        <div class="logo-wrapper">
            <div class="logo-icon">
                <div class="casa-tejado"></div>
                <div class="casa-cuerpo"></div>
            </div>
            <div class="logo-texto">
                <span class="txt-pura">Pura</span><span class="txt-llave">Llave</span>
            </div>
        </div>
        <div id="headerAuth"></div>
    </div>
</header>

<div class="container">
    <h2 class="seccion-titulo">BASE DE DATOS USUARIOS</h2>
    
    <!-- Alerta de seguridad -->
    <div class="alerta-seguridad">
        <span style="font-size: 1.5rem;">üîí</span>
        <div>
            <h3>ZONA DE ALTA SEGURIDAD</h3>
            <p style="margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.8;">Datos encriptados y protegidos. Solo personal autorizado puede acceder.</p>
        </div>
    </div>
    
    <!-- Estad√≠sticas -->
    <div class="estadisticas">
        <div class="stat-card">
            <div class="stat-number" id="totalUsuarios">0</div>
            <div class="stat-label">Total Usuarios</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="usuariosActivos">0</div>
            <div class="stat-label">Usuarios Activos</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="usuariosHoy">0</div>
            <div class="stat-label">Registrados Hoy</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="datosEncriptados">‚úì</div>
            <div class="stat-label">Datos Encriptados</div>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="filtros">
        <h3>Filtrar Usuarios</h3>
        <div class="filtro-grid">
            <div class="filtro-item">
                <label>Estado</label>
                <select id="filtroEstado" onchange="filtrarUsuarios()">
                    <option value="">Todos los estados</option>
                    <option value="activo">Activo</option>
                    <option value="inactivo">Inactivo</option>
                </select>
            </div>
            <div class="filtro-item">
                <label>Nombre</label>
                <input type="text" id="filtroNombre" placeholder="Buscar por nombre" oninput="filtrarUsuarios()">
            </div>
            <div class="filtro-item">
                <label>Email</label>
                <input type="text" id="filtroEmail" placeholder="Buscar por email" oninput="filtrarUsuarios()">
            </div>
            <div class="filtro-item">
                <label>Fecha de Registro</label>
                <input type="date" id="filtroFecha" onchange="filtrarUsuarios()">
            </div>
        </div>
    </div>
    
    <!-- Botones de acci√≥n -->
    <button class="btn-exportar" onclick="exportarDatos()">üì• Exportar Usuarios (JSON)</button>
    <button class="btn-backup" onclick="crearBackup()">üîê Crear Backup Encriptado</button>
    
    <!-- Tabla de datos -->
    <div class="tabla-container">
        <table class="tabla">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>DNI/NIE</th>
                    <th>Tel√©fono</th>
                    <th>Fecha Registro</th>
                    <th>Estado</th>
                    <th>Anuncios</th>
                    <th>Seguridad</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaUsuarios">
                <!-- Se llenar√° con JavaScript -->
            </tbody>
        </table>
    </div>
    
    <div id="mensajeVacio" style="text-align: center; padding: 50px; display: none;">
        <h3 style="color: var(--texto); opacity: 0.6;">No se encontraron usuarios</h3>
        <p style="color: var(--texto); opacity: 0.4;">Intenta ajustar los filtros para ver m√°s resultados</p>
    </div>
</div>

<script>
    // Sistema de encriptaci√≥n simple (solo para demostraci√≥n)
    class SimpleCrypto {
        static encrypt(text) {
            return btoa(text.split('').reverse().join(''));
        }
        
        static decrypt(encryptedText) {
            try {
                return atob(encryptedText).split('').reverse().join('');
            } catch (e) {
                return 'ERROR_DESENCRIPTACION';
            }
        }
        
        static hash(text) {
            let hash = 0;
            for (let i = 0; i < text.length; i++) {
                const char = text.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(16);
        }
    }

    let todosLosUsuarios = [];
    let usuariosFiltrados = [];

    // MODO OSCURO
    function toggleDarkMode() {
        const body = document.body;
        body.classList.toggle('dark-mode');
        const isDark = body.classList.contains('dark-mode');
        localStorage.setItem('darkMode', isDark);
        document.getElementById('btnDark').innerText = isDark ? "‚òÄÔ∏è Modo Claro" : "üåô Modo Oscuro";
    }

    // Formatear fecha
    function formatearFecha(timestamp) {
        const fecha = new Date(timestamp);
        return fecha.toLocaleDateString('es-ES') + ' ' + fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
    }

    // Cargar usuarios con encriptaci√≥n simulada
    function cargarUsuarios() {
        const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
        
        // Simular que los datos est√°n encriptados (en producci√≥n real ser√≠an datos encriptados)
        todosLosUsuarios = usuarios.map(usuario => ({
            ...usuario,
            dniEncriptado: SimpleCrypto.encrypt(usuario.dni || ''),
            telefonoEncriptado: SimpleCrypto.encrypt(usuario.telefono || ''),
            emailHash: SimpleCrypto.hash(usuario.email),
            nivelSeguridad: 'ALTO',
            ultimoAcceso: usuario.ultimoAcceso || usuario.fechaRegistro,
            intentosFallidos: Math.floor(Math.random() * 3)
        }));
        
        usuariosFiltrados = [...todosLosUsuarios];
        
        // Actualizar estad√≠sticas
        actualizarEstadisticas();
        
        // Mostrar usuarios
        mostrarUsuarios();
    }

    // Actualizar estad√≠sticas
    function actualizarEstadisticas() {
        const hoy = new Date().toDateString();
        const usuariosHoy = todosLosUsuarios.filter(u => 
            new Date(u.fechaRegistro).toDateString() === hoy
        );
        
        document.getElementById('totalUsuarios').textContent = todosLosUsuarios.length;
        document.getElementById('usuariosActivos').textContent = todosLosUsuarios.filter(u => u.estado !== 'inactivo').length;
        document.getElementById('usuariosHoy').textContent = usuariosHoy.length;
    }

    // Mostrar usuarios en la tabla
    function mostrarUsuarios() {
        const tbody = document.getElementById('tablaUsuarios');
        const mensajeVacio = document.getElementById('mensajeVacio');
        
        if (usuariosFiltrados.length === 0) {
            tbody.innerHTML = '';
            mensajeVacio.style.display = 'block';
            return;
        }
        
        mensajeVacio.style.display = 'none';
        
        tbody.innerHTML = usuariosFiltrados.map((usuario, index) => {
            const numAnuncios = JSON.parse(localStorage.getItem('misAnuncios') || [])
                .filter(a => a.duenoEmail === usuario.email).length;
            
            return `
                <tr>
                    <td><span class="datos-sensibles">#${index + 1}</span></td>
                    <td><strong>${usuario.nombre}</strong></td>
                    <td>
                        <span class="datos-sensibles">${usuario.email}</span>
                        <br><small style="opacity: 0.6;">Hash: ${usuario.emailHash.substring(0, 8)}...</small>
                    </td>
                    <td>
                        <span class="datos-sensibles">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                        <br><small style="opacity: 0.6;">Encriptado</small>
                    </td>
                    <td>
                        <span class="datos-sensibles">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                        <br><small style="opacity: 0.6;">Encriptado</small>
                    </td>
                    <td>${formatearFecha(usuario.fechaRegistro)}</td>
                    <td>
                        <span class="estado-badge ${usuario.estado === 'activo' ? 'estado-activo' : 'estado-inactivo'}">
                            ${usuario.estado === 'activo' ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td>${numAnuncios}</td>
                    <td>
                        <span class="seguridad-badge encriptado">üîê Encriptado</span>
                        ${usuario.intentosFallidos > 0 ? `<br><span class="seguridad-badge">‚ö†Ô∏è ${usuario.intentosFallidos} fallos</span>` : ''}
                    </td>
                    <td>
                        <div class="acciones">
                            <button class="btn-accion btn-ver" onclick="verDetallesUsuario(${index})">üëÅÔ∏è</button>
                            <button class="btn-accion btn-editar" onclick="editarUsuario(${index})">‚úèÔ∏è</button>
                            <button class="btn-accion btn-eliminar" onclick="eliminarUsuario(${index})">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Filtrar usuarios
    function filtrarUsuarios() {
        const estado = document.getElementById('filtroEstado').value;
        const nombre = document.getElementById('filtroNombre').value.toLowerCase();
        const email = document.getElementById('filtroEmail').value.toLowerCase();
        const fecha = document.getElementById('filtroFecha').value;
        
        usuariosFiltrados = todosLosUsuarios.filter(usuario => {
            const matchEstado = !estado || usuario.estado === estado;
            const matchNombre = !nombre || usuario.nombre.toLowerCase().includes(nombre);
            const matchEmail = !email || usuario.email.toLowerCase().includes(email);
            const matchFecha = !fecha || new Date(usuario.fechaRegistro).toDateString() === new Date(fecha).toDateString();
            
            return matchEstado && matchNombre && matchEmail && matchFecha;
        });
        
        mostrarUsuarios();
    }

    // Ver detalles del usuario (con desencriptaci√≥n simulada)
    function verDetallesUsuario(index) {
        const usuario = usuariosFiltrados[index];
        const dniReal = SimpleCrypto.decrypt(usuario.dniEncriptado);
        const telefonoReal = SimpleCrypto.decrypt(usuario.telefonoEncriptado);
        
        const detalles = `
=== INFORMACI√ìN DE USUARIO ===
ID: #${index + 1}
Nombre: ${usuario.nombre}
Email: ${usuario.email}
DNI/NIE: ${dniReal === 'ERROR_DESENCRIPTACION' ? 'Protegido' : dniReal}
Tel√©fono: ${telefonoReal === 'ERROR_DESENCRIPTACION' ? 'Protegido' : telefonoReal}
Fecha de Registro: ${formatearFecha(usuario.fechaRegistro)}
√öltimo Acceso: ${formatearFecha(usuario.ultimoAcceso)}
Estado: ${usuario.estado}
Intentos Fallidos: ${usuario.intentosFallidos}
Nivel de Seguridad: ${usuario.nivelSeguridad}

=== DATOS DE SEGURIDAD ===
Email Hash: ${usuario.emailHash}
DNI Encriptado: ${usuario.dniEncriptado.substring(0, 20)}...
Tel√©fono Encriptado: ${usuario.telefonoEncriptado.substring(0, 20)}...

=== ANUNCIOS PUBLICADOS ===
Total: ${JSON.parse(localStorage.getItem('misAnuncios') || []).filter(a => a.duenoEmail === usuario.email).length}
        `;
        
        alert(detalles);
    }

    // Editar usuario (simulado - requiere autenticaci√≥n)
    function editarUsuario(index) {
        const usuario = usuariosFiltrados[index];
        alert(`Para editar este usuario, se requiere autenticaci√≥n de administrador.\n\nUsuario: ${usuario.nombre}\nEmail: ${usuario.email}\n\nEsta funci√≥n est√° deshabilitada por seguridad.`);
    }

    // Eliminar usuario (con confirmaci√≥n m√∫ltiple)
    function eliminarUsuario(index) {
        const usuario = usuariosFiltrados[index];
        
        // Confirmaci√≥n m√∫ltiple por seguridad
        const confirmacion1 = prompt('Para eliminar, escribe "ELIMINAR":');
        if (confirmacion1 !== 'ELIMINAR') {
            alert('‚ùå Operaci√≥n cancelada por seguridad.');
            return;
        }
        
        const confirmacion2 = prompt('Confirma escribiendo el email del usuario:');
        if (confirmacion2 !== usuario.email) {
            alert('‚ùå Email incorrecto. Operaci√≥n cancelada.');
            return;
        }
        
        if (!confirm('‚ö†Ô∏è EST√ÅS A PUNTO DE ELIMINAR UN USUARIO PERMANENTEMENTE.\n\nEsta acci√≥n no se puede deshacer.\n\n¬øContinuar?')) {
            return;
        }
        
        // Eliminar usuario
        const indexGlobal = todosLosUsuarios.findIndex(u => u.email === usuario.email);
        if (indexGlobal !== -1) {
            todosLosUsuarios.splice(indexGlobal, 1);
            localStorage.setItem('usuarios', JSON.stringify(todosLosUsuarios));
            
            // Tambi√©n eliminar sus anuncios
            let anuncios = JSON.parse(localStorage.getItem('misAnuncios')) || [];
            anuncios = anuncios.filter(a => a.duenoEmail !== usuario.email);
            localStorage.setItem('misAnuncios', JSON.stringify(anuncios));
            
            cargarUsuarios();
            alert('‚úÖ Usuario y todos sus anuncios eliminados correctamente.');
        }
    }

    // Exportar datos (con encriptaci√≥n)
    function exportarDatos() {
        const datos = {
            fecha_exportacion: new Date().toISOString(),
            total_usuarios: todosLosUsuarios.length,
            nivel_encriptacion: 'SIMPLE_CRYPTO_V1',
            datos_encriptados: true,
            usuarios: todosLosUsuarios.map(u => ({
                id: u.email,
                nombre: u.nombre,
                email_hash: u.emailHash,
                fecha_registro: u.fechaRegistro,
                estado: u.estado,
                nivel_seguridad: u.nivelSeguridad,
                datos_protegidos: {
                    dni: u.dniEncriptado,
                    telefono: u.telefonoEncriptado
                }
            }))
        };
        
        const dataStr = JSON.stringify(datos, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = `purallave_usuarios_${new Date().toISOString().slice(0,10)}_ENCRYPTED.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        alert('üìÅ Datos exportados con encriptaci√≥n de seguridad.');
    }

    // Crear backup encriptado
    function crearBackup() {
        const backupData = {
            timestamp: new Date().toISOString(),
            version: '1.0',
            encrypted: true,
            checksum: SimpleCrypto.hash(JSON.stringify(todosLosUsuarios)),
            usuarios: todosLosUsuarios,
            anuncios: JSON.parse(localStorage.getItem('misAnuncios')) || [],
            metadata: {
                total_usuarios: todosLosUsuarios.length,
                total_anuncios: JSON.parse(localStorage.getItem('misAnuncios')) || [].length,
                fecha_backup: new Date().toISOString()
            }
        };
        
        // Simular encriptaci√≥n del backup completo
        const backupEncriptado = SimpleCrypto.encrypt(JSON.stringify(backupData));
        
        // Guardar backup en localStorage (en producci√≥n ser√≠a en servidor seguro)
        localStorage.setItem('backup_usuarios_' + Date.now(), backupEncriptado);
        
        alert('üîê Backup encriptado creado y almacenado de forma segura.\n\nChecksum: ' + backupData.checksum.substring(0, 16) + '...');
    }

    // Verificar autenticaci√≥n
    function verificarAuth() {
        const user = JSON.parse(localStorage.getItem('usuarioSesion'));
        const headerAuth = document.getElementById('headerAuth');
        
        if (user) {
            headerAuth.innerHTML = `
                <a href="perfil.html" class="btn-perfil">üë§ ${user.nombre}</a>
            `;
        } else {
            headerAuth.innerHTML = `
                <a href="login.html" class="btn-login">Iniciar Sesi√≥n</a>
            `;
        }
    }

    // CARGA INICIAL
    window.onload = () => {
        // Configurar modo oscuro
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            document.getElementById('btnDark').innerText = "‚òÄÔ∏è Modo Claro";
        }
        
        // Verificar autenticaci√≥n
        verificarAuth();
        
        // Cargar usuarios
        cargarUsuarios();
        
        // Log de acceso (simulado)
        console.log('üîê ACCESO A BASE DE DATOS USUARIOS - ' + new Date().toISOString());
        console.log('üìä Total usuarios cargados: ' + (JSON.parse(localStorage.getItem('usuarios')) || []).length);
    };
</script>

</body>
</html>