<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Privado - PuraLlave</title>
    <style>
        :root {
            --primario: #0984e3;
            --secundario: #00b894;
            --fondo: #f1f7f9;
            --blanco: #ffffff;
            --texto: #2d3436;
            --borde: #dfe6e9;
            --mensaje-enviado: #00b894;
            --mensaje-recibido: #0984e3;
        }
        body.dark-mode {
            --fondo: #0f172a;
            --blanco: #1e293b;
            --texto: #f1f2f6;
            --primario: #3498db;
            --secundario: #55efc4;
            --borde: #334155;
        }
        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; background: var(--fondo); color: var(--texto); transition: 0.3s; height: 100vh; display: flex; flex-direction: column; }

        header { background: var(--blanco); padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .logo-wrapper { display: flex; align-items: center; text-decoration: none; }
        .logo-icon { position: relative; width: 35px; height: 40px; margin-right: 10px; }
        .casa-tejado { width: 0; height: 0; border-left: 18px solid transparent; border-right: 18px solid transparent; border-bottom: 13px solid var(--secundario); }
        .casa-cuerpo { width: 28px; height: 22px; background: var(--secundario); margin: 0 auto; border-radius: 0 0 4px 4px; }
        .txt-pura { font-size: 1.6rem; font-weight: 800; color: var(--primario); }
        .txt-llave { font-size: 1.6rem; font-weight: 300; color: var(--secundario); }

        .btn-login { background: transparent; color: var(--primario); border: 2px solid var(--primario); padding: 8px 18px; border-radius: 8px; font-weight: bold; text-decoration: none; transition: 0.3s; }
        .btn-login:hover { background: var(--primario); color: white; }
        .btn-perfil { background: var(--primario); color: white; border: 2px solid var(--primario); padding: 8px 18px; border-radius: 8px; font-weight: bold; text-decoration: none; transition: 0.3s; }
        .btn-perfil:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-volver { background: var(--primario); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-volver:hover { opacity: 0.9; transform: translateY(-2px); }

        .chat-container { flex: 1; display: flex; max-width: 1200px; width: 100%; margin: 0 auto; background: var(--blanco); box-shadow: 0 0 20px rgba(0,0,0,0.1); }

        .chat-sidebar { width: 300px; background: var(--fondo); border-right: 1px solid var(--borde); overflow-y: auto; }
        .chat-header { padding: 20px; background: var(--primario); color: white; }
        .chat-header h3 { margin: 0; font-size: 1.2rem; }
        .chat-list { padding: 10px; }
        .chat-item { padding: 15px; margin-bottom: 10px; background: var(--blanco); border-radius: 10px; cursor: pointer; transition: 0.3s; border: 1px solid transparent; }
        .chat-item:hover { border-color: var(--primario); transform: translateY(-2px); }
        .chat-item.active { border-color: var(--primario); background: rgba(9, 132, 227, 0.1); }
        .chat-item-name { font-weight: bold; color: var(--primario); margin-bottom: 5px; }
        .chat-item-propiedad { font-size: 0.9rem; color: var(--texto); opacity: 0.7; margin-bottom: 5px; }
        .chat-item-ultimo { font-size: 0.8rem; color: var(--texto); opacity: 0.6; }
        .chat-item-hora { float: right; font-size: 0.8rem; color: var(--secundario); }

        .chat-main { flex: 1; display: flex; flex-direction: column; }
        .chat-conversacion-header { padding: 20px; background: var(--blanco); border-bottom: 1px solid var(--borde); display: flex; justify-content: space-between; align-items: center; }
        .chat-conversacion-info h3 { margin: 0; color: var(--primario); }
        .chat-conversacion-info p { margin: 5px 0 0 0; color: var(--texto); opacity: 0.7; font-size: 0.9rem; }

        .chat-mensajes { flex: 1; padding: 20px; overflow-y: auto; background: var(--fondo); }
        .mensaje { margin-bottom: 15px; display: flex; animation: fadeIn 0.3s; }
        .mensaje-enviado { justify-content: flex-end; }
        .mensaje-recibido { justify-content: flex-start; }
        .mensaje-burbuja { max-width: 70%; padding: 12px 16px; border-radius: 18px; word-wrap: break-word; }
        .mensaje-enviado .mensaje-burbuja { background: var(--mensaje-enviado); color: white; border-bottom-right-radius: 4px; }
        .mensaje-recibido .mensaje-burbuja { background: var(--mensaje-recibido); color: white; border-bottom-left-radius: 4px; }
        .mensaje-info { font-size: 0.7rem; margin-top: 5px; color: var(--texto); opacity: 0.6; }
        .mensaje-enviado .mensaje-info { text-align: right; }
        .mensaje-recibido .mensaje-info { text-align: left; }

        .chat-input { padding: 20px; background: var(--blanco); border-top: 1px solid var(--borde); }
        .input-container { display: flex; gap: 10px; align-items: center; }
        .chat-input input { flex: 1; padding: 12px 16px; border: 1px solid var(--borde); border-radius: 25px; background: var(--fondo); color: var(--texto); font-size: 1rem; outline: none; }
        .chat-input input:focus { border-color: var(--primario); }
        .chat-input button { background: var(--primario); color: white; border: none; padding: 12px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .chat-input button:hover { opacity: 0.9; transform: translateY(-2px); }
        .chat-input button:disabled { opacity: 0.5; cursor: not-allowed; }

        .empty-state { text-align: center; padding: 50px; color: var(--texto); opacity: 0.6; }
        .empty-state h3 { margin-bottom: 10px; }
        .empty-state p { margin: 0; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .btn-dark-mode { position: fixed; bottom: 20px; right: 20px; z-index: 1000; padding: 12px 20px; border-radius: 50px; border: none; cursor: pointer; background: var(--primario); color: white; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: 0.3s; }
        @media (max-width: 768px) { 
            .chat-sidebar { width: 250px; }
            .chat-container { flex-direction: column; }
            .chat-sidebar { width: 100%; height: 200px; border-right: none; border-bottom: 1px solid var(--borde); }
            .mensaje-burbuja { max-width: 85%; }
        }
    </style>
</head>
<body>

<button onclick="toggleDarkMode()" class="btn-dark-mode" id="btnDark">üåô Modo Oscuro</button>

<header>
    <div class="header-content">
        <div class="logo-wrapper">
            <div class="logo-icon">
                <div class="casa-tejado"></div>
                <div class="casa-cuerpo"></div>
            </div>
            <div class="logo-texto">
                <span class="txt-pura">Pura</span><span class="txt-llave">Llave</span>
            </div>
        </div>
        <div id="headerAuth"></div>
    </div>
</header>

<div class="chat-container">
    <!-- CHAT SIDEBAR -->
    <div class="chat-sidebar">
        <div class="chat-header">
            <h3>üí¨ Mensajes</h3>
        </div>
        <div class="chat-list" id="chatList"></div>
    </div>
    
    <!-- CHAT MAIN -->
    <div class="chat-main">
        <div id="chatContent">
            <div class="empty-state">
                <h3>üì© Selecciona una conversaci√≥n</h3>
                <p>Elige una conversaci√≥n de la lista para empezar a chatear</p>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleDarkMode() {
        const body = document.body;
        body.classList.toggle('dark-mode');
        const isDark = body.classList.contains('dark-mode');
        localStorage.setItem('darkMode', isDark);
        document.getElementById('btnDark').innerText = isDark ? "‚òÄÔ∏è Modo Claro" : "üåô Modo Oscuro";
    }

    function verificarAuth() {
        const user = JSON.parse(localStorage.getItem('usuarioSesion'));
        const headerAuth = document.getElementById('headerAuth');
        if (user) {
            headerAuth.innerHTML = `<button class="btn-volver" onclick="window.location.href='/index.html'">‚Üê Volver</button>
                <a href="perfil.html" class="btn-perfil">üë§ ${user.nombre}</a>`;
        } else {
            headerAuth.innerHTML = `<button class="btn-volver" onclick="window.location.href='/index.html'">‚Üê Volver</button>
                <a href="login.html" class="btn-login">Iniciar Sesi√≥n</a>`;
        }
    }

    let usuarioActual = null;
    let conversacionActual = null;
    let conversaciones = [];
    let mensajes = [];

    function inicializarChat() {
        usuarioActual = JSON.parse(localStorage.getItem('usuarioSesion'));
        if (!usuarioActual) { mostrarError('Debes iniciar sesi√≥n para acceder al chat.'); return; }
        cargarConversaciones();
        const urlParams = new URLSearchParams(window.location.search);
        const propiedadId = urlParams.get('propiedad');
        const vendedorEmail = urlParams.get('vendedor');
        if (propiedadId && vendedorEmail) { crearConversacionPropiedad(propiedadId, vendedorEmail); }
    }

    function cargarConversaciones() {
        conversaciones = JSON.parse(localStorage.getItem('conversaciones')) || [];
        mensajes = JSON.parse(localStorage.getItem('mensajes')) || [];
        const conversacionesUsuario = conversaciones.filter(c => c.participantes.includes(usuarioActual.email));
        mostrarListaConversaciones(conversacionesUsuario);
    }

    function mostrarListaConversaciones(conversacionesUsuario) {
        const chatList = document.getElementById('chatList');
        if (conversacionesUsuario.length === 0) {
            chatList.innerHTML = `<div style="text-align: center; padding: 30px; color: var(--texto); opacity: 0.6;">
                <p>üì≠ No tienes conversaciones a√∫n</p>
                <p style="font-size: 0.9rem; margin-top: 10px;">Las conversaciones aparecer√°n aqu√≠ cuando contactes con vendedores</p>
            </div>`;
            return;
        }
        chatList.innerHTML = conversacionesUsuario.map(conv => {
            const otroEmail = conv.participantes.find(p => p !== usuarioActual.email);
            const otroAlias = getAliasUsuario(otroEmail);
            const msgs = mensajes.filter(m => m.conversacionId === conv.id);
            const ultimo = msgs[msgs.length-1];
            return `<div class="chat-item ${conversacionActual === conv.id ? 'active':''}" onclick="abrirConversacion('${conv.id}')">
                <div class="chat-item-name">${otroAlias}</div>
                <div class="chat-item-propiedad">${conv.propiedadTitulo || 'Sin propiedad'}</div>
                <div class="chat-item-ultimo">${ultimo ? ultimo.texto.substring(0,30)+'...' : 'Sin mensajes'}
                    <span class="chat-item-hora">${ultimo ? formatearHora(ultimo.fecha):''}</span>
                </div>
            </div>`;
        }).join('');
    }

    function crearConversacionPropiedad(propiedadId, vendedorEmail) {
        const anuncios = JSON.parse(localStorage.getItem('misAnuncios')) || [];
        const propiedad = anuncios.find(a => a.fecha == parseInt(propiedadId));
        if (!propiedad) { mostrarError('La propiedad no existe.'); return; }
        let conv = conversaciones.find(c => c.participantes.includes(usuarioActual.email) && c.participantes.includes(vendedorEmail) && c.propiedadId===propiedadId);
        if (!conv) {
            conv = { id:'conv_'+Date.now(), participantes:[usuarioActual.email,vendedorEmail], propiedadId:propiedadId, propiedadTitulo:propiedad.titulo, fecha:Date.now(), creadaPor:usuarioActual.email };
            conversaciones.push(conv);
            localStorage.setItem('conversaciones', JSON.stringify(conversaciones));
            enviarMensajeInicial(conv, propiedad);
        }
        abrirConversacion(conv.id);
    }

    function enviarMensajeInicial(conv, propiedad) {
        const msg = { id:'msg_'+Date.now(), conversacionId:conv.id, remitente:usuarioActual.email, texto:`Hola, estoy interesado/a en tu propiedad: "${propiedad.titulo}".`, fecha:Date.now(), leido:false };
        mensajes.push(msg);
        localStorage.setItem('mensajes', JSON.stringify(mensajes));
    }

    function abrirConversacion(id) {
        conversacionActual = id;
        const conv = conversaciones.find(c=>c.id===id);
        const otro = conv.participantes.find(p=>p!==usuarioActual.email);
        document.querySelectorAll('.chat-item').forEach(i=>i.classList.remove('active'));
        mostrarConversacion(conv, otro);
    }

    function mostrarConversacion(conv, otroEmail) {
        const otroAlias = getAliasUsuario(otroEmail);
        const chatContent = document.getElementById('chatContent');
        chatContent.innerHTML = `<div class="chat-conversacion-header">
            <div class="chat-conversacion-info"><h3>${otroAlias}</h3><p>üìç ${conv.propiedadTitulo || 'Conversaci√≥n privada'}</p></div>
            <button class="btn-volver" onclick="cerrarConversacion()">‚úï Cerrar</button>
        </div>
        <div class="chat-mensajes" id="mensajesContainer"></div>
        <div class="chat-input">
            <div class="input-container">
                <input type="text" id="mensajeInput" placeholder="Escribe tu mensaje..." onkeypress="handleKeyPress(event)">
                <button onclick="enviarMensaje()" id="btnEnviar">Enviar</button>
            </div>
        </div>`;
        cargarMensajes(conv.id);
        document.getElementById('mensajeInput').focus();
    }

    function cargarMensajes(convId) {
        const container = document.getElementById('mensajesContainer');
        const msgs = mensajes.filter(m=>m.conversacionId===convId);
        if (msgs.length===0) {
            container.innerHTML = `<div class="empty-state"><p>üìù Esta conversaci√≥n no tiene mensajes a√∫n</p><p style="font-size:0.9rem;">S√© el primero en escribir</p></div>`;
            return;
        }
        container.innerHTML = msgs.map(m=>`<div class="mensaje ${m.remitente===usuarioActual.email?'mensaje-enviado':'mensaje-recibido'}">
            <div class="mensaje-burbuja">${m.texto}</div>
            <div class="mensaje-info">${formatearHora(m.fecha)} ${m.leido?'‚úì‚úì':'‚úì'}</div>
        </div>`).join('');
        container.scrollTop = container.scrollHeight;
    }

    function enviarMensaje() {
        const input = document.getElementById('mensajeInput');
        const texto = input.value.trim(); if(!texto) return;
        const msg = { id:'msg_'+Date.now(), conversacionId:conversacionActual, remitente:usuarioActual.email, texto:texto, fecha:Date.now(), leido:false };
        mensajes.push(msg);
        localStorage.setItem('mensajes', JSON.stringify(mensajes));
        input.value='';
        cargarMensajes(conversacionActual);
        cargarConversaciones();
        input.focus();
    }

    function handleKeyPress(e) { if(e.key==='Enter'){ enviarMensaje(); } }

    function cerrarConversacion() { conversacionActual=null; inicializarChat(); }

    function getAliasUsuario(email) {
        const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
        const usuario = usuarios.find(u => u.email === email);
        return usuario ? usuario.alias || usuario.nombre : email;
    }

    function formatearHora(timestamp) {
        const d = new Date(timestamp);
        return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0');
    }

    function mostrarError(msg) { alert(msg); window.location.href='/index.html'; }

    window.addEventListener('load', () => {
        if(localStorage.getItem('darkMode')==='true') document.body.classList.add('dark-mode');
        verificarAuth();
        inicializarChat();
    });
</script>

</body>
</html>
